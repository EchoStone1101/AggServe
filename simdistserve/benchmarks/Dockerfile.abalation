FROM runpod/base:0.5.1-cpu

SHELL ["/bin/bash", "-c"]
WORKDIR /app

# Install dependencies
RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt/lists \
    apt update


# Install development software & set up development environment
# Here we need openssh-server to enable SSH service for runpod
RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt/lists \
    --mount=type=cache,target=/root/.cache/pip \
    apt update && \
    apt install -y --no-install-recommends nano vim sudo wget fish openssh-server lsof zip unzip btop tree psmisc && \
    echo "alias conda=micromamba" | tee -a /root/.bashrc | tee -a /root/.config/fish/config.fish && \
    echo "alias mamba=micromamba" | tee -a /root/.bashrc | tee -a /root/.config/fish/config.fish && \
    echo 'export SWIFT_TRANSFORMER_LIB_PATH="/app/SwiftTransformer/libst_pybinding.so"' >> /app/envvars && \
    echo 'export EXP_RESULT_ROOT="/workspace/exp-results"' >> /app/envvars && \
    echo 'export RAY_DEDUP_LOGS=0' >> /app/envvars && \
    echo '. /app/envvars' >> /root/.bashrc && \
    echo '. /app/envvars' >> /root/.config/fish/config.fish && \
    eval "$(micromamba shell hook --shell bash)" && \
    micromamba activate distserve && \
    pip install matplotlib ipykernel simpy tqdm matplotlib pandas joblib shlex 

